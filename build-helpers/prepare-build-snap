#!/bin/bash
set -eu

# build and release it

# Note: we need bionic meson version and sassc. As only those additions alongside git will be installed
# change directly sources.list
cmd="sed -i s/xenial/bionic/g /etc/apt/sources.list && apt update -qq && cd $(pwd) && snapcraft"

# Only release as a snap from main repo (ubuntu slug), enabling other forks to test build the snap.
# Notes that the tokens are only available when the source repo is under ubuntu/ project.
YARU_BRANCH="$TRAVIS_BRANCH"

if [ "$TRAVIS_BRANCH" == "bionic" ]; then
    if [ "$TRAVIS_PULL_REQUEST" != "false" ]; then
        # if it's a PR event, publish a special snap
        channel="edge/${TRAVIS_REPO_SLUG#*/}-pr$TRAVIS_PULL_REQUEST"
        YARU_BRANCH="$TRAVIS_PULL_REQUEST_BRANCH"
        echo "PR to bionic ubuntu repo: will release to $channel"
    else
        # this is an official edge snap
        channel="edge"
    fi
else
    echo "skipping: snaps are only for bionic builds"
    exit 0
fi

echo "Push to bionic ubuntu repo: will release to $channel"

cmd="$cmd && echo \"$SNAP_TOKEN\" | snapcraft login --with - && snapcraft push *.snap --release=$channel"

docker run -v $(pwd):$(pwd) -t snapcore/snapcraft:stable sh -c "$cmd"

# build now gtk-common-themes
response="$(curl --request POST \
        --form "token=$COMMON_THEMES_TRIGGER_TOKEN" \
        --form ref=master \
        --form "variables[YARU_SOURCE_COMMIT]=$TRAVIS_COMMIT" \
        --form "variables[RELEASE_CHANNEL]=$channel" \
        https://gitlab.gnome.org/api/v4/projects/4790/trigger/pipeline)"
pipeline_url=$(echo "$response" | sed -n 's/^.*"web_url": *"\([^"]*pipeline[^"]*\)".*$/\1/p')

# write on PR install instructions for the snap branch
[ "$TRAVIS_PULL_REQUEST" == "false" ] && exit 0
curl -H "Authorization: token ${GITHUB_TOKEN}" -X POST \
        -d "{\"body\": \"A new test snap version is available using: \`snap refresh communitheme --channel=$channel\`.\nFurther available updates will track that pull request then.\n\nSwitch back to stable or edge snap with \`snap refresh communitheme --stable\` or \`snap refresh communitheme --edge\` once you are done with it!\n\nA `gtk-common-themes` snap [is being built]($pipeline_url). When ready, it may be downloaded from the \`$channel\` channel to test your snaps with those changes.\n\nReplace \`refresh\` with \`install\` if you haven't installed the snap yet.\"}" \
        "https://api.github.com/repos/${TRAVIS_REPO_SLUG}/issues/${TRAVIS_PULL_REQUEST}/comments"
